name: Release Wheels

on:
  push:
    tags:
      - 'v*'

permissions:
  actions: read
  contents: write
  id-token: write

jobs:
  wheels:
    name: Build ${{ matrix.os }} / py${{ matrix.py }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, macos-14, windows-2022]
        py: ["3.11","3.12","3.13","3.14"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.py }}
      - name: Install maturin
        run: pip install maturin==1.*
      - name: Build wheels (CPU+WGPU)
        run: |
          maturin build -m bindings/st-py/Cargo.toml --release --features wgpu,logic,kdsl
      - name: Upload wheels (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-py${{ matrix.py }}
          path: target/wheels/*.whl

  attach:
    name: Attach wheels to GitHub Release
    needs: wheels
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Generate checksums for release wheels
        run: |
          set -euo pipefail
          find dist -type f -name '*.whl' -print0 | sort -z | xargs -0 sha256sum > dist/wheels.sha256
          find dist -type f -name '*.whl' -print0 | sort -z | xargs -0 sha512sum > dist/wheels.sha512
      - name: Generate SBOM for release payload
        uses: anchore/sbom-action@v0.16.0
        with:
          path: dist
          format: cyclonedx-json
          output-file: dist/spiraltorch-${{ github.ref_name }}-sbom.cdx.json
          artifact-name: spiraltorch-${{ github.ref_name }}-sbom
          upload-release-assets: false
      - name: Generate SLSA provenance for wheels
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'dist/**/*.whl'
      - name: Sign release artifacts with Sigstore
        uses: sigstore/gh-action-sigstore@v2.3.1
        with:
          inputs: |
            dist/**/*.whl
      - name: Create/Update GitHub Release with assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/**/*
