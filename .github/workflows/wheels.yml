name: Wheels
on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build-wheels:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-13, ubuntu-22.04]
        py: ['3.10', '3.11', '3.12']
        feat: ['wgpu', 'wgpu,hip', 'wgpu,cuda']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.py }}
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Build wheel
        run: |
          python -m pip install -U pip wheel maturin
          # Example: feature flags are illustrative; adapt to your crate layout.
          maturin build --release -m bindings/st-py/Cargo.toml --features "${{ matrix.feat }}"
      - name: Smoke test wheel import
        working-directory: target/wheels
        env:
          PYTHONNOUSERSITE: "1"
        run: |
          python -m pip install --force-reinstall --no-cache-dir spiraltorch-*.whl
          python - <<'PY'
          import spiraltorch as st

          print("import ok:", len(getattr(st, "__all__", ())))
          assert hasattr(st, "optim")
          assert hasattr(st.optim, "Amegagrad")

          opt = st.optim.Amegagrad((1, 3), curvature=-0.9, hyper_learning_rate=0.03, real_learning_rate=0.02)
          weights = st.Tensor(1, 3, [0.2, -0.1, 0.05])
          opt.accumulate_wave(st.Tensor(1, 3, [0.4, -0.6, 0.2]))
          before = weights.tolist()
          opt.step(weights, tune=False)
          after = weights.tolist()
          assert after != before

          trainer = st.ZSpaceTrainer(z_dim=4)
          loss = trainer.step(
              {"speed": 0.2, "memory": 0.1, "stability": 0.9, "gradient": opt.real.gradient()}
          )
          float(loss)
          partial_loss = trainer.step_partial(
              {"speed": 0.15, "memory": 0.1, "stability": 0.92, "gradient": [0.1, 0.0, 0.0, 0.0]}
          )
          float(partial_loss)
          assert trainer.last_inference is not None

          assert hasattr(st, "LanguageWaveEncoder")
          encoder = st.LanguageWaveEncoder(-1.0, 0.5)
          probe = encoder.encode_z_space("SpiralTorch")
          rows, cols = probe.shape()
          text_opt = st.optim.Amegagrad((rows, cols), curvature=float(encoder.curvature()))
          text_weights = st.Tensor(rows, cols, [0.0] * (rows * cols))
          text_opt.absorb_text(encoder, "SpiralTorch wheels smoke test")
          before = text_weights.tolist()
          control = text_opt.desire_control()
          text_opt.step(text_weights, tune=True, control=control)
          after = text_weights.tolist()
          assert after != before

          print("smoke ok")
          PY
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.os }}-py${{ matrix.py }}-${{ matrix.feat }}
          path: target/wheels/*.whl
