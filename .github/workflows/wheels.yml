name: Wheels
on:
  push:
    tags: ["v*"]
    branches: ["main"]
  pull_request:

jobs:
  build-wheels:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        feature: [cpu, wgpu, mps]
    steps:
      - uses: actions/checkout@v4
      - uses: PyO3/maturin-action@v1
        with:
          working-directory: bindings/st-py
          args: >
            --release
            --locked
            ${{ matrix.feature == 'wgpu' && '--features wgpu' || '' }}
            ${{ matrix.feature == 'mps' && '--features mps' || '' }}
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.feature }}
          path: bindings/st-py/target/wheels/*.whl
